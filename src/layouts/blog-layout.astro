---
import "../styles/base.css";
import "../styles/blog.css";

import CvHeader from "$components/cv/cv-header.svelte";
import SiteFooter from "$components/layout/site-footer.svelte";
import TableOfContents from "$components/blog/table-of-contents.svelte";
import { getTranslations } from "../i18n";
import type { Locale } from "../i18n";
import type { MarkdownHeading } from "astro";

interface Props {
  title: string;
  description?: string;
  image?: string;
  publishedAt?: Date;
  updatedAt?: Date;
  tags?: string[];
  headings?: MarkdownHeading[];
  lang?: Locale;
}

const {
  title,
  description,
  image,
  publishedAt,
  updatedAt,
  tags = [],
  headings = [],
  lang = "de",
} = Astro.props;

const isProd = import.meta.env.PROD;
const t = getTranslations(lang);

// Filter headings to only include h2 and h3
const tocHeadings = headings
  .filter((h) => h.depth === 2 || h.depth === 3)
  .map((h) => ({
    id: h.slug,
    text: h.text,
    level: h.depth,
  }));

const showToc = tocHeadings.length > 2;

// Format date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat(lang === "de" ? "de-DE" : "en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(date);
};
---

<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{title} | {t.meta.title}</title>
    <meta name="description" content={description || t.meta.description} />
    {image && <meta property="og:image" content={image} />}
  </head>
  <body>
    <CvHeader
      name="Arne Wiese"
      title="Freelancer & Consultant"
      location={lang === "en" ? "Meerbusch, Germany" : "Meerbusch, Deutschland"}
      email="arne@wiese.me"
      website="arnewiese.de"
      imageUrl="/assets/arne-neu-quadratisch.jpeg"
      lang={lang}
    />

    <main class="space-y-12 md:space-y-24">
      <article class="app-grid">
        <div class="app-text-column">
          <!-- Hero Section -->
          <header class="blog-hero">
            <h1 class="blog-hero-title">{title}</h1>
            <div class="blog-hero-meta">
              {publishedAt && (
                <time datetime={publishedAt.toISOString()}>
                  {formatDate(publishedAt)}
                </time>
              )}
              {tags.length > 0 && (
                <div class="blog-hero-tags">
                  {tags.map((tag) => (
                    <span class="blog-hero-tag">{tag}</span>
                  ))}
                </div>
              )}
            </div>
            {image && (
              <img src={image} alt="" class="blog-cover" />
            )}
          </header>

          <!-- Mobile ToC -->
          {showToc && (
            <details class="blog-toc-mobile">
              <summary>Inhaltsverzeichnis</summary>
              <TableOfContents headings={tocHeadings} client:idle />
            </details>
          )}
        </div>

        <!-- Article Layout with Sidebar -->
        <div class="app-wide-column">
          <div class="blog-layout">
            <!-- Desktop ToC Sidebar -->
            {showToc && (
              <aside class="blog-toc-sidebar">
                <TableOfContents headings={tocHeadings} client:idle />
              </aside>
            )}

            <!-- Article Content -->
            <div class="blog-article blog-prose">
              <slot />
            </div>
          </div>
        </div>
      </article>
    </main>

    <SiteFooter lang={lang} currentPath={Astro.url.pathname} />

    {isProd && <script data-domain="arnewiese.de" src="/js/script.js" />}
  </body>
</html>
