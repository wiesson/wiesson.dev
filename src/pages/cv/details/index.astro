---
import BaseLayout from "@/layouts/BaseLayout.astro";
import CvHeader from "@/components/cv-header";
import CvWorkListing from "../../../components/cv-work-listing";
import CvEducationListing from "../../../components/cv-education-listing";
import { getCollection } from "astro:content";

const cvWork = await getCollection("work");
const cvEducation = await getCollection("education");
cvWork.sort((a, b) => {
  // Handle "now" entries - current positions come first
  const aIsNow = a.data.to === "now";
  const bIsNow = b.data.to === "now";

  if (aIsNow && !bIsNow) return -1;  // a comes first
  if (!aIsNow && bIsNow) return 1;   // b comes first
  if (aIsNow && bIsNow) {
    // Both current - sort by start date descending
    return new Date(b.data.from).valueOf() - new Date(a.data.from).valueOf();
  }

  // Neither is current - sort by end date descending
  const dateATo = new Date(a.data.to);
  const dateBTo = new Date(b.data.to);

  if (dateBTo.valueOf() !== dateATo.valueOf()) {
    return dateBTo.valueOf() - dateATo.valueOf();
  }

  // Tiebreaker: sort by start date descending
  return new Date(b.data.from).valueOf() - new Date(a.data.from).valueOf();
});
---

<BaseLayout>
  <CvHeader
    name="Arne Wiese"
    title="Senior AI Software Engineer"
    location="Meerbusch, Germany"
    email="arne@wiese.me"
    website="wiesson.dev"
    imageUrl="/assets/arne-neu-quadratisch.jpeg"
    client:load
  />

  <CvWorkListing
    title="Projekte & Festanstellungen"
    items={cvWork.filter((item) => item.data.type === "main")}
    showDetails
  />

  <CvWorkListing
    title="Nebenprojekte"
    items={cvWork.filter((item) => item.data.type === "side")}
    showDetails
  />

  <CvEducationListing title="Ausbildung" items={cvEducation} showDetails />
</BaseLayout>
