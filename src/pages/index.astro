---
import BaseLayout from "$layouts/base-layout.astro";
import ServicesSection from "$components/sections/services-section.astro";
import FeaturedProjectsSection from "$components/sections/featured-projects-section.astro";
import CvWorkListing from "$components/cv/cv-work-listing.svelte";
import TechnologiesSection from "$components/sections/technologies-section.astro";
import ProjectsSection from "$components/sections/projects-section.astro";
import { getCollection } from "astro:content";
import { getTranslations } from "../i18n";

const lang = "de";
const t = getTranslations(lang);
const cvWork = await getCollection("work");

const now = new Date();

cvWork.sort((a, b) => {
  const toA = a.data.to === "now" ? now : a.data.to;
  const toB = b.data.to === "now" ? now : b.data.to;
  return toB.getTime() - toA.getTime();
});

const recentMainWork = cvWork
  .filter((item) => item.data.type === "main")
  .slice(0, 5);

const totalProjects = cvWork.filter((item) => item.data.type === "main").length;
const startYear = cvWork.length > 0
  ? new Date(Math.min(...cvWork.map((w) => new Date(w.data.from).getTime()))).getFullYear()
  : new Date().getFullYear();
---

<BaseLayout lang={lang}>
  <!-- Lebenslauf link - absolute top right -->
  <a
    href="/cv"
    class="fixed top-4 right-4 text-sm text-muted-foreground hover:text-foreground transition-colors z-50"
  >
    {t.nav.cv}
  </a>

  <!-- Prose intro section -->
  <section class="app-grid">
    <article class="app-text-column prose dark:prose-invert prose-neutral max-w-none leading-relaxed">
      <p>
        Ich bin freiberuflicher Softwareentwickler und entwickle Webapplikationen
        und SaaS-Produkte. Zudem berate ich bei Architektur-Entscheidungen,
        technischen Audits und der Modernisierung bestehender Systeme. In den
        letzten Jahren habe ich u.a. bei <a
          href="https://frontnow.com"
          target="_blank"
          rel="noopener"
          class="underline">Frontnow</a
        >, <a
          href="https://douglas.de"
          target="_blank"
          rel="noopener"
          class="underline">Parfümerie Douglas</a
        >, <a
          href="https://carauktion.de"
          target="_blank"
          rel="noopener"
          class="underline">carauktion</a
        > und <a
          href="https://sipgate.de"
          target="_blank"
          rel="noopener"
          class="underline">sipgate</a
        > gearbeitet.
      </p>

      <p>
        Ende 2025 habe ich <a
          href="https://nordwerk.studio"
          target="_blank"
          rel="noopener"
          class="underline">Studio Nordwerk</a
        > gegründet, ein AI- und Software-Studio für pragmatische SaaS-Lösungen und
        schnelle MVPs.
      </p>
    </article>
  </section>

  <ServicesSection lang={lang} />
  <FeaturedProjectsSection lang={lang} />

  <CvWorkListing
    title={t.sections.workExperience}
    subtitle={t.sections.workExperienceSubtitle
      .replace("{count}", totalProjects.toString())
      .replace("{year}", startYear.toString())}
    items={recentMainWork}
    lang={lang}
    showIntro
    showBadges={false}
    showYearsOnly={true}
    viewAllLink={{
      href: "/cv",
      label: t.sections.viewAllProjects,
    }}
  />

  <TechnologiesSection lang={lang} />
  <ProjectsSection lang={lang} />
</BaseLayout>
